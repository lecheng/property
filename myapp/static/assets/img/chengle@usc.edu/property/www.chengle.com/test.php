<?php
$DISCOVER_PHONE_RATIO = 480.0/695;
$DISCOVER_NONPHONE_RATIO = 1200.0/695;
$SLIDESHOW_2_PT1 = "      <!-- SLIDE  -->\n      <li data-index=\"slideshow-2\" data-transition=\"fade\" data-title=\"Slideshow 1\" data-masterspeed=\"300\">\n        <!-- MAIN IMAGE -->\n        <img src=\"assets/dummy.png\" data-lazyload=\"";
$SLIDESHOW_2_PT2 = "\" data-bgposition=\"center center\" data-bgfit=\"cover\" data-bgparallax=\"8\" class=\"rev-slidebg\" data-no-retina>\n        <!-- LAYERS --></li>\n";
$GALLERY_PT1 = "      <!-- SLIDE  -->\n      <li data-index=\"g-";
$GALLERY_PT2 = "\" data-transition=\"fade\"   data-invisible=\"true\"  data-title=\"Gallery\" >\n        <!-- MAIN IMAGE -->\n        <img src=\"assets/dummy.png\" style='background-color:#424242'>\n        <!-- LAYERS -->\n\n        <!-- LAYER NR. 1 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT2_VIMEO = "\" data-transition=\"fade\"   data-invisible=\"true\"  data-title=\"Gallery\" >\n        <!-- MAIN IMAGE -->\n        <img src=\"assets/dummy.png\" style='background-color:#424242'>\n        <!-- LAYERS -->\n\n        <!-- LAYER NR. 1 -->\n        <div class=\"tp-caption tp-resizeme tp-videolayer\" id=\"g-";
$GALLERY_PT3 = "-layer-1\" data-x=\"['center','center','center','center']\" data-hoffset=\"['0','0','0','0']\" data-y=\"['top','top','top','top']\" data-voffset=\"['20','20','20','";
$GALLERY_PT4 = "']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_in=\"y:10px;opacity:0;s:1000;e:Power4.easeOut;\" data-transform_out=\"auto:auto;s:500;e:Power2.easeInOut;\" data-start=\"500\" data-responsive_offset=\"on\" style=\"z-index: 1;\"><img src=\"assets/dummy.png\"  ";
$GALLERY_PT4_VIMEO = "']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_in=\"y:10px;opacity:0;s:1000;e:Power4.easeOut;\" data-transform_out=\"auto:auto;s:500;e:Power2.easeInOut;\" data-start=\"500\" data-responsive_offset=\"on\" data-vimeoid=\"";
$GALLERY_PT4_YOUTUBE = "']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_in=\"y:10px;opacity:0;s:1000;e:Power4.easeOut;\" data-transform_out=\"auto:auto;s:500;e:Power2.easeInOut;\" data-start=\"500\" data-responsive_offset=\"on\" data-ytid=\"";
$GALLERY_PT5 = " data-lazyload=\"";
$GALLERY_PT5_VIMEO = "\" data-videoattributes=\"\" data-videowidth=\"['1200px','984px','738px','480px']\" data-videoheight=\"['695px','570px','427px','278px']\" data-videoloop=\"none\" data-autoplay=\"off\" data-volume=\"100\" style=\"z-index: 1;\"> </div>\n\n        <!-- LAYER NR. 2 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT5_YOUTUBE = "\" data-videoattributes=\"\" data-videowidth=\"['1200px','984px','738px','480px']\" data-videoheight=\"['695px','570px','427px','278px']\" data-videoloop=\"none\" data-autoplay=\"off\" data-volume=\"100\" style=\"z-index: 1;\"> </div>\n\n        <!-- LAYER NR. 2 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT6 = "\" data-no-retina> </div>\n\n        <!-- LAYER NR. 2 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT7 = "-layer-2\" data-x=\"['right','right','right','right']\" data-hoffset=\"['10','10','10','-10']\" data-y=\"['top','top','top','top']\" data-voffset=\"['10','10','10','10']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_hover=\"o:1;rX:0;rY:0;rZ:0;z:0;s:150;e:Power1.easeInOut;\" data-style_hover=\"c:rgba(255, 255, 255, 0.75);\" data-transform_in=\"x:20px;opacity:0;s:1000;e:Power4.easeOut;\" data-transform_out=\"auto:auto;s:500;e:Power2.easeInOut;\" data-start=\"750\" data-actions='[{\"event\":\"click\",\"action\":\"jumptoslide\",\"slide\":\"rs-7\",\"delay\":\"\"}]' data-responsive_offset=\"on\" style=\"z-index: 2; white-space: nowrap; font-size: 100px; line-height: 100px; color: rgba(255, 255, 255, 1.00);cursor:pointer;\"><i class=\"pe-7s-close\"></i> </div>\n\n        <!-- LAYER NR. 3 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT8 = "-layer-3\" data-x=\"['center','center','center','center']\" data-hoffset=\"['50','50','50','50']\" data-y=\"['top','top','top','top']\" data-voffset=\"['625','500','357','625']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_hover=\"o:1;rX:0;rY:0;rZ:0;z:0;s:150;e:Power1.easeInOut;\" data-style_hover=\"c:rgba(255, 255, 255, 0.75);\" data-start=\"0\" data-actions='[{\"event\":\"click\",\"action\":\"jumptoslide\",\"slide\":\"g-";
$GALLERY_PT9 = "\",\"delay\":\"\"}]' data-responsive_offset=\"on\" style=\"z-index: 2; white-space: nowrap; font-size: 100px; line-height: 100px; color: rgba(255, 255, 255, 1.00);cursor:pointer;\"><i class=\"pe-7s-angle-right\"></i> </div>\n\n        <!-- LAYER NR. 4 -->\n        <div class=\"tp-caption tp-resizeme\" id=\"g-";
$GALLERY_PT10 = "-layer-4\" data-x=\"['center','center','center','center']\" data-hoffset=\"['-50','-50','-50','-50']\" data-y=\"['top','top','top','top']\" data-voffset=\"['625','500','357','625']\" data-width=\"none\" data-height=\"none\" data-whitespace=\"nowrap\" data-transform_idle=\"o:1;\" data-transform_hover=\"o:1;rX:0;rY:0;rZ:0;z:0;s:150;e:Power1.easeInOut;\" data-style_hover=\"c:rgba(255, 255, 255, 0.75);\" data-start=\"0\" data-actions='[{\"event\":\"click\",\"action\":\"jumptoslide\",\"slide\":\"g-";
$GALLERY_PT11 = "\",\"delay\":\"\"}]' data-responsive_offset=\"on\" style=\"z-index: 2; white-space: nowrap; font-size: 100px; line-height: 100px; color: rgba(255, 255, 255, 1.00);cursor:pointer;\"><i class=\"pe-7s-angle-left\"></i> </div></li>";
?>

<?php 
function recurse_copy($src,$dst) { 
    $dir = opendir($src); 
    if (!mkdir($dst)) {
    	die('Failed to create directory '.$dst.'.');
	}
    while(false !== ( $file = readdir($dir)) ) { 
        if (( $file != '.' ) && ( $file != '..' )) { 
            if ( is_dir($src . '/' . $file) ) { 
                recurse_copy($src . '/' . $file,$dst . '/' . $file); 
            } 
            else { 
                copy($src . '/' . $file,$dst . '/' . $file); 
            } 
        } 
    } 
    closedir($dir); 
}

function zip_and_download($source, $destination) {
    // Get real path for our folder
	$rootPath = realpath($source);

	// Initialize archive object
	$zip = new ZipArchive();
	$zip->open($destination, ZipArchive::CREATE | ZipArchive::OVERWRITE);

	// Create recursive directory iterator
	/** @var SplFileInfo[] $files */
	$files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($rootPath), RecursiveIteratorIterator::LEAVES_ONLY);

	foreach ($files as $name => $file) {
    	// Skip directories (they would be added automatically)
    	if (!$file->isDir()) {
       		// Get real and relative path for current file
        	$filePath = $file->getRealPath();
        	$relativePath = substr($filePath, strlen($rootPath) + 1);

        	// Add current file to archive
        	$zip->addFile($filePath, $relativePath);
    	}
	}

	// Zip archive will be created only after closing object
	$zip->close();

    header("Pragma: public");
    header("Expires: 0");
    header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
    header("Cache-Control: public");
    header("Content-Description: File Transfer");
    header("Content-type: application/zip");
    header("Content-Disposition: attachment; filename=\"".$destination."\"");
    header("Content-Length: ".filesize($destination));
    ob_clean();
    flush();
    readfile($destination);   
}

function get_wwhh($width, $height) {
	
	$ratio = $width/$height;
	if ($ratio >= $GLOBALS['DISCOVER_NONPHONE_RATIO']) 
		return "data-ww=\"['"."1200"."px','"."984"."px','"."738"."px','"."480"."px']\" data-hh=\"['".(1200/$ratio)."px','".(984/$ratio)."px','".(738/$ratio)."px','".(480/$ratio)."px']\"";
	else if ($ratio <= $GLOBALS['DISCOVER_PHONE_RATIO']) 
		return "data-ww=\"['".(695*$ratio)."px','".(570*$ratio)."px','".(427*$ratio)."px','".(695*$ratio)."px']\" data-hh=\"['"."695"."px','"."570"."px','"."427"."px','"."695"."px']\"";
	else 
		return "data-ww=\"['".(695*$ratio)."px','".(570*$ratio)."px','".(427*$ratio)."px','"."480"."px']\" data-hh=\"['"."695"."px','"."570"."px','"."427"."px','".(480/$ratio)."px']\"";
}

function rrmdir($dir) { 
  foreach(glob($dir . '/*') as $file) { 
    if (is_dir($file)) rrmdir($file); 
    else unlink($file); 
  } 
  rmdir($dir); 
}

function currencyConvert($amount,$from,$to) {
    $url  = "https://www.google.com/finance/converter?a=$amount&from=$from&to=$to";
    $data = file_get_contents($url);
    preg_match("/<span class=bld>(.*)<\/span>/",$data, $converted);
    $converted = preg_replace("/[^0-9.]/", "", $converted[1]);
    return $converted;
}

function voffset_on_phone($width, $height) {
    $ratio = $width/$height;
    if ($ratio >= $GLOBALS['DISCOVER_NONPHONE_RATIO']) 
        $height_phone = 480/$ratio;
    else if ($ratio <= $GLOBALS['DISCOVER_PHONE_RATIO']) 
        $height_phone = 695;
    else 
        $height_phone = 480/$ratio;

    $screen_height = 695;
    $base_offset = 20;
    return $base_offset+($screen_height/2)-($height_phone/2);
}

?>



<?php
if (ini_get("max_file_uploads") < 100)
    die("<strong>ERROR!</strong> Your current php configuration only allows ".ini_get("max_file_uploads")." files upload. Please increase \"max_file_uploads\" in \"php.ini\" to at least 100.");

// property info initialization
$attribute = array(
	"address1" => "",
	"address2" => "",
	"address3" => "",
	"price" => "",
	"price_CNY" => "",
	"beds" => "",
	"baths" => "",
	"home_size" => "",
	"home_size_meter" => "",
	"lot_size" => "",
	"lot_size_meter" => "",
	"year_built" => "",
	"property_type_English" => "",
	"property_type_Chinese" => "",
	"list_date_English" => "",
	"school_district_English" => "",
	"school_district_Chinese" => "",
	"description_English" => "",
	"description_Chinese" => "",
	"agent_name" => "",
    "agent_license" => "",
	"agent_phone" => "",
	"agent_phone_China" => "",
	"agent_wechat" => "",
	"agent_email" => "",
	"agent_office" => "",
	"slogan_title_English" => "",
	"slogan_subtitle_English" => "",
	"slogan_title_Chinese" => "",
	"slogan_subtitle_Chinese" => "",
    "vimeo" => "",
    "youtube" => "",
);
$image = array(
	"grid_overview" => "",
	"grid_gallery" => "",
	"grid_contact" => "",
	"grid_explore" => "",
	"background_overview" => "",
	"background_contact" => "",
	"background_contact_phone" => "",
	"background_explore" => "",
	"QR_code" => "",

);
$slideshow = array();
$gallery = array();
$errors = array();
$full_address = "";
$full_address_br = "";

// read from html form
if ($_SERVER["REQUEST_METHOD"] == "POST") {

	foreach ($_POST as $key => $value) {
		if ($key == "submit") continue;
		$attribute[$key] = trim($_POST[$key]);
	}
    if (!empty($attribute["vimeo"]) && !empty($attribute["youtube"])) 
        array_push($errors, "Can't have both Vimeo and Youtube video. Choose one of the two.");

    $total_byte_size = 0;
	foreach ($image as $key => $value) {
        list($w, $h) = getimagesize($_FILES[$key]["tmp_name"]);
        $total_byte_size += filesize($_FILES[$key]["tmp_name"]);
        if ($key == "grid_overview" && !($w==390 && $h==340))
            array_push($errors, "Grid Overview image should be 390px &times; 340px.");
        if ($key == "grid_gallery" && !($w==390 && $h==340))
            array_push($errors, "Grid Gallery image should be 390px &times; 340px.");
        if ($key == "grid_contact" && !($w==390 && $h==695))
            array_push($errors, "Grid Contact image should be 390px &times; 695px.");
        if ($key == "grid_explore" && !($w==795 && $h==340))
            array_push($errors, "Grid Explore image should be 795px &times; 340px.");
        if ($key == "background_overview" && !($w==1200 && $h==695))
            array_push($errors, "Background Overview image should be 1200px &times; 695px.");
        if ($key == "background_contact" && !($w==1200 && $h==695))
            array_push($errors, "Background Contact image should be 1200px &times; 695px.");
        if ($key == "background_contact_phone" && !($w==480 && $h==695))
            array_push($errors, "Background Contact (Phone) image should be 480px &times; 695px.");
        if ($key == "background_explore" && !($w==1200 && $h==695))
            array_push($errors, "Background Explore image should be 1200px &times; 695px.");
        if ($key == "QR_code" && !($w==$h))
            array_push($errors, "QR Code image should be square.");
		$image[$key] = $_FILES[$key]["name"];
	}
    if ($total_byte_size > 1000000)
        array_push($errors, "Grid and Background images should not exceed 1MB in total size. They are now ".$total_byte_size/1000000.0." MB. Please use more compressed images for grid and background.");

    $total_byte_size = 0;
	foreach ($_FILES["slideshow"]["name"] as $key => $value) {
        $w = getimagesize($_FILES["slideshow"]["tmp_name"][$key])[0];
        $total_byte_size += filesize($_FILES["slideshow"]["tmp_name"][$key]);
        if ($w != 1600)
            array_push($errors, "Slideshow images should all be 1600px in width, but \"".$_FILES["slideshow"]["name"][$key]."\" has a width of ".$w.".");
		array_push($slideshow, $value);
	}
    if ($total_byte_size > 10000000)
        array_push($errors, "Slideshow images should not exceed 10MB in total size. They are now ".$total_byte_size/1000000.0." MB. Please use fewer and/or more compressed images for slideshow.");

    $total_byte_size = 0;
	foreach ($_FILES["gallery"]["name"] as $key => $value) {
        list($w, $h) = getimagesize($_FILES["gallery"]["tmp_name"][$key]);
        $total_byte_size += filesize($_FILES["gallery"]["tmp_name"][$key]);
        if ($w>1200 || $h>695)
            array_push($errors, "Gallery images should be smaller than 1200px &times; 695 px, but \"".$_FILES["gallery"]["name"][$key]."\" is ".$w." &times; ".$h.".");
		array_push($gallery, $value);
	}
    if ($total_byte_size > 50000000)
        array_push($errors, "Gallery images should not exceed 50MB in total size. They are now ".$total_byte_size/1000000.0." MB. Please use fewer and/or more compressed images for gallery.");
}

// print errors and early termination
if (!empty($errors)) {
    foreach ($errors as $error) {
        echo "<strong>ERROR!</strong> ".$error."<br>";
    }
    die("<br>Please go back, correct your input, and retry.<br>");
}

// unit convertions
$attribute["price_CNY"] = currencyConvert($attribute["price"], "USD", "CNY");
$attribute["home_size_meter"] = $attribute["home_size"]*0.092903;
$attribute["lot_size_meter"] = $attribute["lot_size"]*0.092903;

// re-format some attributes
$attribute["price"] = "$".number_format($attribute["price"]);
$attribute["price_CNY"] = "Â¥".number_format($attribute["price_CNY"]);
$attribute["home_size"] = number_format($attribute["home_size"])." Sq. Ft.";
$attribute["home_size_meter"] = number_format($attribute["home_size_meter"])." m<sup>2</sup>";
$attribute["lot_size"] = number_format($attribute["lot_size"])." Sq. Ft.";
$attribute["lot_size_meter"] = number_format($attribute["lot_size_meter"])." m<sup>2</sup>";
if (empty($attribute["address2"])) {
    $full_address = $attribute["address1"].", ".$attribute["address3"];
    $full_address_br = $attribute["address1"]."<br>".$attribute["address3"];
}
else {
    $full_address = $attribute["address1"].", ".$attribute["address2"].", ".$attribute["address3"];
    $full_address_br = $attribute["address1"]."<br>".$attribute["address2"]."<br>".$attribute["address3"];
}
$site_directory = str_replace(' ', '', $attribute["address1"]);

// foreach ($attribute as $key => $value) {
// 	echo $key.": ";
// 	var_dump($attribute[$key]);
// 	echo "<br>";
// }
// foreach ($image as $key => $value) {
// 	echo $key.": ";
// 	var_dump($image[$key]);
// 	echo "<br>";
// }
// foreach ($slideshow as $key => $value) {
// 	echo $key.": ";
// 	var_dump($slideshow[$key]);
// 	echo "<br>";
// }
// foreach ($gallery as $key => $value) {
// 	echo $key.": ";
// 	var_dump($gallery[$key]);
// 	echo "<br>";
// }

// copy images and resources
recurse_copy("./source/source",$site_directory);
if (!mkdir($site_directory."/cn")) {
    die('Failed to create en directory.');
}
foreach ($image as $key => $value) {
	move_uploaded_file($_FILES[$key]["tmp_name"], $site_directory."/assets/".$_FILES[$key]["name"]);
}
foreach ($_FILES["slideshow"]["tmp_name"] as $key => $value) {
	move_uploaded_file($value, $site_directory."/assets/".$_FILES["slideshow"]["name"][$key]);
}
foreach ($_FILES["gallery"]["tmp_name"] as $key => $value) {
	move_uploaded_file($value, $site_directory."/assets/".$_FILES["gallery"]["name"][$key]);
}

// write to index.html
$myfile = fopen($site_directory."/index.html", "w");
$file = fopen("source/index_en.temp","r");
while(!feof($file)) {
	$line = trim(fgets($file));
	if (strlen($line) >= 3 && substr($line, 0, 3) == "###") {
		//var_dump($line);
		//echo "<br>";
		switch ($line) {
    		case "### Site Title":
        		fwrite($myfile, $full_address."\n");
        		break;
            case "### Meta Description":
                fwrite($myfile, "\"".$full_address."\"\n");
                break;
    		case "### Slideshow 1":
        		fwrite($myfile, "\""."assets/".$slideshow[0]."\""."\n");
        		break;
    		case "### Slideshow 2":
        		for ($i = 1; $i < count($slideshow); $i++) 
    	    		fwrite($myfile, $SLIDESHOW_2_PT1."assets/".$slideshow[$i].$SLIDESHOW_2_PT2."\n");
        		break;
        	case "### Address":
        		fwrite($myfile, $full_address_br."\n");
        		break;
        	case "### Slogan 1":
        		fwrite($myfile, $attribute["slogan_title_English"]."\n");
        		break;
        	case "### Slogan 2":
        		fwrite($myfile, $attribute["slogan_subtitle_English"]."\n");
        		break;
        	case "### Grid 1":
        		fwrite($myfile, "\""."assets/".$image["grid_overview"]."\""."\n");
        		break;
        	case "### Grid 2":
        		fwrite($myfile, "\""."assets/".$image["grid_gallery"]."\""."\n");
        		break;
        	case "### Grid 3":
        		fwrite($myfile, "\""."assets/".$image["grid_contact"]."\""."\n");
        		break;
        	case "### Grid 4":
        		fwrite($myfile, "\""."assets/".$image["grid_explore"]."\""."\n");
        		break;
        	case "### Background 1":
        		fwrite($myfile, "\""."assets/".$image["background_overview"]."\""."\n");
        		break;
        	case "### Background 3":
        		fwrite($myfile, "\""."assets/".$image["background_contact"]."\""."\n");
        		break;
        	case "### Background 3 Phone":
        		fwrite($myfile, "\""."assets/".$image["background_contact_phone"]."\""."\n");
        		break;
        	case "### Background 4":
        		fwrite($myfile, "\""."assets/".$image["background_explore"]."\""."\n");
        		break;
        	case "### Details":
        		fwrite($myfile, $attribute["price"]."<br>".$attribute["beds"]."<br>".$attribute["baths"]."<br>".$attribute["home_size"]."<br>".$attribute["lot_size"]."<br>".$attribute["year_built"]."<br>".$attribute["property_type_English"]."<br>".$attribute["list_date_English"]."<br>".$attribute["school_district_English"]."\n");
        		break;
        	case "### Description":
        		fwrite($myfile, $attribute["description_English"]."\n");
        		break;
        	case "### Google Map":
        		fwrite($myfile, "\"https://www.google.com/maps/embed/v1/place?key=AIzaSyCDV3pj4XCo2e5x9XqNE7HYCyV3m0u-qsA&q=".$full_address."\""."\n");
        		break;
        	case "### Contact Title":
        		fwrite($myfile, $attribute["agent_name"]."\n");
        		break;
        	case "### Contact Subtitle":
        		fwrite($myfile, $attribute["agent_license"]."<br>".$attribute["agent_phone"]."<br>".$attribute["agent_phone_China"]."<br>".$attribute["agent_wechat"]."<br>".$attribute["agent_email"]."<br>".$attribute["agent_office"]."\n");
        		break;
        	case "### Contact QR":
        		fwrite($myfile, "\""."assets/".$image["QR_code"]."\""."\n");
        		break;
        	case "### Gallery":
                $gallery_size = count($gallery);
                if (!empty($attribute["vimeo"])) {
                    $gallery_size++;
                    $voffset = voffset_on_phone(480.0, 278.0);
                    $prev = $gallery_size-1;
                    $next = 1;
                    fwrite($myfile, $GALLERY_PT1.'0'.$GALLERY_PT2_VIMEO.'0'.$GALLERY_PT3.$voffset.$GALLERY_PT4_VIMEO.$attribute["vimeo"].$GALLERY_PT5_VIMEO.'0'.$GALLERY_PT7.'0'.$GALLERY_PT8.$next.$GALLERY_PT9.'0'.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
                }
                else if (!empty($attribute["youtube"])) {
                    $gallery_size++;
                    $voffset = voffset_on_phone(480.0, 278.0);
                    $prev = $gallery_size-1;
                    $next = 1;
                    fwrite($myfile, $GALLERY_PT1.'0'.$GALLERY_PT2_VIMEO.'0'.$GALLERY_PT3.$voffset.$GALLERY_PT4_YOUTUBE.$attribute["youtube"].$GALLERY_PT5_YOUTUBE.'0'.$GALLERY_PT7.'0'.$GALLERY_PT8.$next.$GALLERY_PT9.'0'.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
                }
        		foreach ($gallery as $i => $value) {
                    if (!empty($attribute["vimeo"]) || !empty($attribute["youtube"])) $i++;
        			list($width, $height) = getimagesize($site_directory."/assets/".$value);
					$wwhh = get_wwhh(($width+0.0), ($height+0.0));
                    $voffset = voffset_on_phone(($width+0.0), ($height+0.0));
					$prev = $i-1; if ($prev == -1) $prev = $gallery_size-1;
    	    	    $next = $i+1; if ($next == $gallery_size) $next = 0;
    	    	    fwrite($myfile, $GALLERY_PT1.$i.$GALLERY_PT2.$i.$GALLERY_PT3.$voffset.$GALLERY_PT4.$wwhh.$GALLERY_PT5."assets/".$value.$GALLERY_PT6.$i.$GALLERY_PT7.$i.$GALLERY_PT8.$next.$GALLERY_PT9.$i.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
				}
        		break;
		}
	}
	else 
		fwrite($myfile, $line."\n");
}
fclose($file); fclose($myfile);

// write to cn/index.html
$myfile = fopen($site_directory."/cn/index.html", "w");
$file = fopen("source/index.temp","r");
while(!feof($file)) {
	$line = trim(fgets($file));
	if (strlen($line) >= 3 && substr($line, 0, 3) == "###") {
		//var_dump($line);
		//echo "<br>";
		switch ($line) {
    		case "### Site Title":
        		fwrite($myfile, $full_address."\n");
        		break;
            case "### Meta Description":
                fwrite($myfile, "\"".$full_address."\"\n");
                break;
    		case "### Slideshow 1":
        		fwrite($myfile, "\""."../assets/".$slideshow[0]."\""."\n");
        		break;
    		case "### Slideshow 2":
        		for ($i = 1; $i < count($slideshow); $i++) 
    	    		fwrite($myfile, $SLIDESHOW_2_PT1."../assets/".$slideshow[$i].$SLIDESHOW_2_PT2."\n");
        		break;
        	case "### Address":
        		fwrite($myfile, $full_address_br."\n");
        		break;
        	case "### Slogan 1":
        		fwrite($myfile, $attribute["slogan_title_Chinese"]."\n");
        		break;
        	case "### Slogan 2":
        		fwrite($myfile, $attribute["slogan_subtitle_Chinese"]."\n");
        		break;
        	case "### Grid 1":
        		fwrite($myfile, "\""."../assets/".$image["grid_overview"]."\""."\n");
        		break;
        	case "### Grid 2":
        		fwrite($myfile, "\""."../assets/".$image["grid_gallery"]."\""."\n");
        		break;
        	case "### Grid 3":
        		fwrite($myfile, "\""."../assets/".$image["grid_contact"]."\""."\n");
        		break;
        	case "### Grid 4":
        		fwrite($myfile, "\""."../assets/".$image["grid_explore"]."\""."\n");
        		break;
        	case "### Background 1":
        		fwrite($myfile, "\""."../assets/".$image["background_overview"]."\""."\n");
        		break;
        	case "### Background 3":
        		fwrite($myfile, "\""."../assets/".$image["background_contact"]."\""."\n");
        		break;
        	case "### Background 3 Phone":
        		fwrite($myfile, "\""."../assets/".$image["background_contact_phone"]."\""."\n");
        		break;
        	case "### Background 4":
        		fwrite($myfile, "\""."../assets/".$image["background_explore"]."\""."\n");
        		break;
        	case "### Details":
        		fwrite($myfile, $attribute["price"]."<br>".$attribute["beds"]."<br>".$attribute["baths"]."<br>".$attribute["home_size_meter"]."<br>".$attribute["lot_size_meter"]."<br>".$attribute["year_built"]."<br>".$attribute["property_type_Chinese"]."<br>".$attribute["list_date_English"]."<br>".$attribute["school_district_Chinese"]."\n");
        		break;
        	case "### Description":
        		fwrite($myfile, $attribute["description_Chinese"]."\n");
        		break;
        	case "### Google Map":
        		fwrite($myfile, "\"https://www.google.com/maps/embed/v1/place?key=AIzaSyCDV3pj4XCo2e5x9XqNE7HYCyV3m0u-qsA&q=".$full_address."\""."\n");
        		break;
        	case "### Contact Title":
        		fwrite($myfile, $attribute["agent_name"]."\n");
        		break;
        	case "### Contact Subtitle":
        		fwrite($myfile, $attribute["agent_license"]."<br>".$attribute["agent_phone"]."<br>".$attribute["agent_phone_China"]."<br>".$attribute["agent_wechat"]."<br>".$attribute["agent_email"]."<br>".$attribute["agent_office"]."\n");
        		break;
        	case "### Contact QR":
        		fwrite($myfile, "\""."../assets/".$image["QR_code"]."\""."\n");
        		break;
        	case "### Gallery":
        		$gallery_size = count($gallery);
                if (!empty($attribute["vimeo"])) {
                    $gallery_size++;
                    $voffset = voffset_on_phone(480.0, 278.0);
                    $prev = $gallery_size-1;
                    $next = 1;
                    fwrite($myfile, $GALLERY_PT1.'0'.$GALLERY_PT2_VIMEO.'0'.$GALLERY_PT3.$voffset.$GALLERY_PT4_VIMEO.$attribute["vimeo"].$GALLERY_PT5_VIMEO.'0'.$GALLERY_PT7.'0'.$GALLERY_PT8.$next.$GALLERY_PT9.'0'.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
                }
                else if (!empty($attribute["youtube"])) {
                    $gallery_size++;
                    $voffset = voffset_on_phone(480.0, 278.0);
                    $prev = $gallery_size-1;
                    $next = 1;
                    fwrite($myfile, $GALLERY_PT1.'0'.$GALLERY_PT2_VIMEO.'0'.$GALLERY_PT3.$voffset.$GALLERY_PT4_YOUTUBE.$attribute["youtube"].$GALLERY_PT5_YOUTUBE.'0'.$GALLERY_PT7.'0'.$GALLERY_PT8.$next.$GALLERY_PT9.'0'.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
                }
                foreach ($gallery as $i => $value) {
                    if (!empty($attribute["vimeo"]) || !empty($attribute["youtube"])) $i++;
                    list($width, $height) = getimagesize($site_directory."/assets/".$value);
                    $wwhh = get_wwhh(($width+0.0), ($height+0.0));
                    $voffset = voffset_on_phone(($width+0.0), ($height+0.0));
                    $prev = $i-1; if ($prev == -1) $prev = $gallery_size-1;
                    $next = $i+1; if ($next == $gallery_size) $next = 0;
                    fwrite($myfile, $GALLERY_PT1.$i.$GALLERY_PT2.$i.$GALLERY_PT3.$voffset.$GALLERY_PT4.$wwhh.$GALLERY_PT5."../assets/".$value.$GALLERY_PT6.$i.$GALLERY_PT7.$i.$GALLERY_PT8.$next.$GALLERY_PT9.$i.$GALLERY_PT10.$prev.$GALLERY_PT11."\n\n");
                }
                break;
		}
	}
	else 
		fwrite($myfile, $line."\n");
}
fclose($file); fclose($myfile);

// zip and download
zip_and_download($site_directory, $site_directory.".zip");

// delete files
unlink($site_directory.".zip");
rrmdir($site_directory);

?>
